#!/bin/sh

set -e

VERSION="1.1.2"

if command -v dpkg > /dev/null; then
    ARCH="$(dpkg --print-architecture | awk -F- '{ print $NF }')"
fi

download() {
    /usr/local/bin/install-go-replace "$1"
}

if [ -f "/opt/docker/ARCH_INFO.txt" ]; then
    ARCH_FILE="/opt/docker/ARCH_INFO.txt"
    while IFS="=" read -r key value; do
        case "$key" in
          "BUILDARCH") BUILDARCH="$value" ;;
          "TARGETARCH") TARGETARCH="$value" ;;
        esac
      done < "$ARCH_FILE"
fi

if [ ! -n "$BUILDARCH" ]; then
    if ! command -v dpkg > /dev/null; then
        echo "dpkg not installed and BUILDARCH was not found"
        exit 2
    fi

    BUILDARCH="$ARCH"
fi

for TARGET in "$BUILDARCH" "$TARGETARCH"; do
    if [ -n "$TARGET" ] && [ ! -x "/usr/local/bin/go-replace-$TARGET" ]; then
        download "$TARGET"
    fi
done

if [ -n "$BUILDARCH" ]; then
    exec "/usr/local/bin/go-replace-$BUILDARCH" "$@"
else
    exec "/usr/local/bin/go-replace-$ARCH" "$@"
fi
